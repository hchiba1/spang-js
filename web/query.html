<!DOCTYPE html>
<!-- saved from url=(0029)http://localhost:7070/library -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="./css/application.css">
  <title>
    SPANG
  </title>
  <link rel="shortcut icon" type="image/x-icon"
        href="./favicon.ico">
  <script src="https://unpkg.com/json5@^2.0.0/dist/index.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sparql/sparql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  <script src='https://cdn.jsdelivr.net/gh/sparqling/spang@864c3ac/js/spang.min.js'></script>
  <script id="common-header-and-footer__script" src="https://dbcls.rois.ac.jp/DBCLS-common-header-footer/v2/script/common-header-and-footer.js" type="text/javascript"></script>


  <script src="./js/sparql-support.js"></script>
  <script src="./js/common.js"></script>
</head>
<body style="padding-top: 24px;">
<div class="content_wrapper_wide">
  <div class="small">
    <a href="https://spang.dbcls.jp/">
      SPANG
    </a>
    &gt;&gt;
    <a href="./index.html">
      Library
    </a>
    &gt;&gt;
    <a id="breadcrumb-library">
    </a>
    &gt;&gt;
    <label id="breadcrumb-current">
    </label>
  </div>

  <p>
  </p>
  <h1>Execute SPARQL query</h1>
  <form>
    <div id="endpoint-div"></div>
    <br>
    <br>
    <textarea id="code" name="code"></textarea>
    <br>
    <button id="submit_button_query" type="button" style="display: none;">
      Exec
    </button>
  </form>
</div>


</body>
<script>
  let params = new URLSearchParams(window.location.search);
  let libraryName = params.get("library");
  let queryName = params.get("query");
  
  $(document).ready(function(event) {
    let textArea = document.getElementById("code");
    let originalValue = textArea.value;

    let editor = CodeMirror.fromTextArea(textArea, {
      mode: "application/sparql-query",
      matchBrackets: true,
      autoCloseBrackets: true,
      lineNumbers: true,
      sparqlSupportAutoComp: true,
      scrollbarStyle: "null",
      viewportMargin: Infinity,
      extraKeys: {
        "Tab": function (instance) {
          return false;
        }, "Ctrl-Space": function (instance) {
          return false;
        }
      }
    });
    
    const historyTraversal = event.persisted ||
      ( typeof window.performance != "undefined" &&
        window.performance.navigation.type === 2 );
    onConfigLoad.push(() => {
      let libraryConfig = configList.find(config => config.name === libraryName);
      let endpoint = libraryConfig.endpoint;
      let title = libraryConfig.title || libraryName;

      selector("#breadcrumb-library").innerText = title;
      selector("#breadcrumb-library").href = `./library.html?name=${libraryName}`;
      selector("#breadcrumb-current").innerText = queryName;

      if(libraryConfig.endpoint) {
        document.querySelector("#endpoint-div").innerHTML = `Endpoint: ${libraryConfig.title} ( <a href="${libraryConfig.endpoint}">${libraryConfig.endpoint}</a> )`;
        $('#submit_button_query').show();
      } 
      $.get(`https://raw.githubusercontent.com/${repo}/${tag}/library/${libraryName}/${queryName}`, (res) => {
        let metadata = spang.retrieveMetadata(res);
        if(historyTraversal) {
          editor.setValue(localStorage.getItem("lastQuery"))
        } else {
          let sparql = spang.makeSparql(res, metadata, {}, []);
          let lines = sparql.split("\n");
          console.log(lines);
          lines = lines.filter(line => !line.startsWith("#!")); // Remove shebang line
          lines = lines.filter(line => !(line.startsWith("#") && line.substring(1).trim().startsWith("@option"))); // Remove lines of @option
          editor.setValue(lines.join("\n"));
        }


        if (endpoint === "https://query.wikidata.org/") {
          $('#submit_button_query').on('click',
            function () {
              localStorage.setItem("lastQuery", editor.getValue());
              window.location.assign(endpoint + '#' + encodeURIComponent(editor.getValue()))
            }
          );
        } else if (endpoint) {
          $('#submit_button_query').on('click',
            function () {
              localStorage.setItem("lastQuery", editor.getValue());
              window.location.assign(endpoint + '?query=' + encodeURIComponent(editor.getValue()));
            }
          );
        }
      });
    })
  });
  

</script>

</html>
